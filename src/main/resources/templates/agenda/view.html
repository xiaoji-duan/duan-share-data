<!doctype html>
<html lang="zh-cmn-Hans">
<head>
<!-- Required meta tags -->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport"
  content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
<style>
body {
  padding-top: 8px;
  padding-bottom: 8px;
}

div > img {
  max-height: 80%;
  max-width: 80%;
}
</style>
<title th:text="${data.evn}">冥王星 活动</title>
</head>
<body>
  <div class="container-fluid">
    <div class="card">
      <div class="card-header" th:text="${data.evd}">
		    Featured
		  </div>
		  <div class="card-body">
        <p class="card-text" th:text="${data.evn}">With supporting text below as a natural lead-in to additional content.</p>
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#loginModal">加入这个活动</button>
		  </div>
		</div>
  </div>
  <p>补充</p>
  <div th:each="attachment,iterStat : ${data.attachments}">
    <a th:if="${!#strings.isEmpty(attachment.fjurl)}" th:href="@{${#strings.replace(attachment.fjurl,'getSnapshot','getContent')}}"> 
      <img alt="" th:src="${attachment.fjurl}">
    </a>
    <p th:text="${attachment.fjn}"></p>
  </div>
  <a class="open-mwxing">打开 冥王星</a>
  
	<div class="modal" id="loginModal" tabindex="-1" role="dialog">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title">冥王星帐户验证</h5>
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	          <span aria-hidden="true">&times;</span>
	        </button>
	      </div>
	      <div class="modal-body">
	        <form>
            <input type="hidden" id="from_phoneno" th:value="${data.share_from.phoneno}">
            <input type="hidden" id="from_name" th:value="${data.share_from.name}">
            <input type="hidden" id="data_phoneno" th:value="${data.ui}">
            <input type="hidden" id="data_id" th:value="${data.evi}">
	          <div class="form-group">
	            <label for="user-name" class="col-form-label">帐号:</label>
	            <input type="text" class="form-control" id="user-name" required>
	          </div>
	          <div class="form-group">
	            <label for="user-password" class="col-form-label">密码:</label>
	            <input type="password" class="form-control" id="user-password" required>
	          </div>
	        </form>
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
	        <button type="button" class="btn btn-primary" id="login">确定</button>
	      </div>
	    </div>
	  </div>
	</div>
<script type="text/javascript">
var $as = document.querySelectorAll('a.open-mwxing');

if(navigator.userAgent.match(/(iPhone|iPod|iPad);?/i)) {
  document.write("iOS");
//  window.location.href = "itms-apps://itunes.apple.com/cn/app/海约/id1265041589?mt=8"; //ios app协议
//  window.setTimeout(function() {
//      window.location.href = "https://***";
//  }, 2000);
} else if(navigator.userAgent.match(/android/i)) {
  document.write("Android");
  $as[0].addEventListener('touchend', function() {
    window.location.href = "cn.sh.com.xj.timeApp://app"; //android app协议
//  window.setTimeout(function() {
//  window.location.href = "https://fir.im/d2z3"; //android 下载地址
//}, 2000);
  });
} else {
  document.write(navigator.userAgent);
}

//避免touchmove事件影响touchend
stopTouchendPropagationAfterScroll();

function stopTouchendPropagationAfterScroll() {
    var flag = false;
    window.addEventListener('touchmove', function(ev) {
        flag || (flag = true, window.addEventListener('touchend', stopTouchendPropagation, true));
    }, false);

    function stopTouchendPropagation(ev) {
        ev.stopPropagation();
        setTimeout(function() {
            window.removeEventListener('touchend', stopTouchendPropagation, true);
            flag = false;
        }, 50);
    }
}
</script>
<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
<script type="text/javascript">
$(function() {
  var sendJoinRequest = function(userinfo, from, data) {
    $.ajax({
      type: "POST",
      url: "https://pluto.guobaa.com/cdc/mwxing_data_join_start/json/trigger",
      data: JSON.stringify({
        userinfo: userinfo,
        deviceId: "web_wxshare",
        from: from,
        data: data
      }),
      contentType: "application/json",
      dataType: "json",
      success: function(resp) {
        $('#loginModal').modal('hide');
        alert("加入请求发送成功");
      },
      error: function() {}
    });
  }
  
  var getUserinfo = function(openid) {
    $.ajax({
      type: "GET",
      url: "https://pluto.guobaa.com/aup/user/" + openid + "/userinfo",
      data: "",
      dataType: "json",
      success: function(resp) {
        if (resp && resp.data) {
          var userinfo = resp.data;
          delete userinfo.avatar;
          delete userinfo.avatarbase64;
          
          sendJoinRequest(userinfo, {
            phoneno: $("#from_phoneno").val(),
            name: $("#from_name").val(),
          }, {
            datatype: "Agenda",
            datas: [{
	            phoneno: $("#data_phoneno").val(),
	            id: $("#data_id").val()
	          }]}
          );
        }
      },
      error: function(error) {
        alert("login error");
      }
    });
  }
  
  $("#login").click(function() {
    $.ajax({
      type: "POST",
      url: "https://pluto.guobaa.com/aup/dologin",
      contentType: "application/json",
      data: JSON.stringify({
        phoneno: $("#user-name").val(),
        userpassword: $("#user-password").val()
      }),
      dataType: "json",
      success: function(resp) {
        if (resp && resp.openid) {
          getUserinfo(resp.openid);
        }
      },
      error: function(error) {
        alert("login error");
      }
    });
  });
});
</script>
</body>
</html>